# Originally /opt/rocm/hip/samples/0_Intro/square/Makefile
# Modified for testing in a PAPI environment.

include ../../Makefile_comp_tests.target

HIPCC_FOUND := $(shell hipcc --version)

HIPCC=hipcc

INCLUDE+=-I${HOME}/papi/src/

all: 

# I'm not sure why, but on Tulip we fail to compile and link due to library issues.
# Breaking into two steps, Object and Link, solves the issue.
rocm_all.o: rocm_all.cpp test_hipcc
	$(HIPCC) $(CXXFLAGS) $(INCLUDE) rocm_all.cpp -c -o $@ 

rocm_all.out: rocm_all.o test_hipcc
	$(HIPCC) $(CXXFLAGS) $(INCLUDE) rocm_all.o -o $@ $(UTILOBJS) $(PAPILIB) $(LDFLAGS)
	rm -f rocm_all.o 

test_hipcc:
ifeq ("" , "$(HIPCC_FOUND)")
$(error hipcc compiler not found. Perhaps a 'module load rocm' is required, or 'PATH' environment variable needs to be updated.)
endif

checkpath: 
	echo HIPCC_FOUND = '$(HIPCC_FOUND)'
	echo HIP_PATH = $(HIP_PATH)
	echo SOURCES = $(SOURCES)
	echo HIP_PLATFORM = $(HIP_PLATFORM)
	echo HIPCC = $(HIPCC)
	echo INCLUDE = $(INCLUDE)

clean:
	rm -f *.o *.out
