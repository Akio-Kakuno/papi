SUBSTR  = linux-perfctr
DESCR	= "Linux with PerfCtr patch for all Pentiums and the AMD K7"
LIBS	= static shared
TARGETS = serial multiplex pthreads 

KERNINC	= /usr/src/linux-2.4.2-perfctr-1.6/include
PERFCTR	= ./perfctr
CFLAGS  = -I$(PERFCTR)/usr.lib -I$(PERFCTR)/linux/include -I$(KERNINC) -I. -Wall -g -DPERFCTR16
#-DDEBUG -DMPX_DEBUG -DMPX_DEBUG_TIMER
FFLAGS	= -Wall -g -Dlinux
OPTFLAGS= -O3 -mpentiumpro
FOPTFLAGS= $(OPTFLAGS)
CC	= gcc
F77	= g77
CC_SHR  = $(CC) -shared -Xlinker "-soname" -Xlinker "libpapi.so" -Xlinker "-rpath" -Xlinker "$(PWD)"
CC_R	= $(CC) -pthread
MISCOBJS= libperfctr.o

include Makefile.inc

x86-events.h: $(PERFCTR)/etc/mk-events-h.awk $(PERFCTR)/etc/perfctr-events.tab
	awk -f $(PERFCTR)/etc/mk-events-h.awk $(PERFCTR)/etc/perfctr-events.tab > $@

libperfctr.o: $(PERFCTR)/usr.lib/libperfctr.o x86-events.h
	cp $(PERFCTR)/usr.lib/libperfctr.o .

$(PERFCTR)/usr.lib/libperfctr.o: $(PERFCTR)/config.out
	$(MAKE) -C $(PERFCTR)

$(PERFCTR)/config.out:
	-cd $(PERFCTR); ./configure

clean-perfctr:
	$(MAKE) -C $(PERFCTR)
