# $Id$
#
# GNU G77/GCC section
#
F77   		= g77 -Wall
CC		= gcc -Wall
CC_R    	= $(CC) -pthread
CC_SHR		= $(CC) $(SHRFLAGS) -shared -Xlinker "-soname" -Xlinker "libpapi.so" -Xlinker "-rpath" -Xlinker "$(PREFIX)/lib"
GCCVER3		= $(shell gcc -v 2>&1 | grep version | cut -f3 -d" " | grep "^3")
ifeq (,$(GCCVER3))
OPTFLAGS	+= -g -DDEBUG
# -O -g -DDEBUG
else
GCCVER33	= $(shell gcc -v 2>&1 | tail -n 1 | grep version | cut -f3 -d" " | cut -f2 -d"." | grep "^3")
ifeq (,$(GCCVER33))
OPTFLAGS	+= $(GCC3ARGS) -g -DDEBUG
else
OPTFLAGS	+= $(GCC3ARGS) -g -DDEBUG
endif
endif

ARCH		:= $(shell uname -m | grep x86_64)
ifeq (x86_64,$(ARCH))
SHRFLAGS	:= -fPIC
LIB_SUFFIX	:= 64
endif

# Flags for test programs
FFLAGS        	+= -Dlinux -ffixed-line-length-132
TOPTFLAGS	+= -O -g 
FTOPTFLAGS	= $(TOPTFLAGS)
# 
# #  Portland Group PGF77 section
# #
# F77       = pgf77
# FFLAGS    = -O3 -Dlinux
# FTOPTFLAGS= $(FOPTFLAGS)
# #
# #  Intel Corp. Fortran compiler
# #
# F77      = ifc
# FFLAGS   = -Dlinux
# LDFLAGS  = -lPEPCF90 -lIEPCF90 -lF90 -lintrins # Intel portability library (getarg_)
# FOPTFLAGS= -O3 -tpp6
# FTOPTFLAGS= $(FOPTFLAGS)

#
# DO NOT TOUCH BELOW HERE UNLESS YOU KNOW WHAT YOU ARE DOING
#

ifeq (,$(PERFCTR_PREFIX))
PERFCTR ?= ./perfctr-$(VERSION)
PERFCTR_LIB_PATH ?= $(PERFCTR)/usr.lib
PERFCTR_INC_PATH ?= $(PERFCTR)/usr.lib
PERFCTR_KINC_PATH ?= $(PERFCTR)/linux/include
else
PERFCTR_LIB_PATH ?= $(PERFCTR_PREFIX)/lib$(LIB_SUFFIX)
PERFCTR_INC_PATH ?= $(PERFCTR_PREFIX)/include
PERFCTR_KINC_PATH ?= $(PERFCTR_INC_PATH)
endif

DESCR   = "Linux with PerfCtr $(VERSION) patch and library"
LIBRARY = libpapi.a
SHLIB   = libpapi.so
SUBSTR  = perfctr-$(CPU)
MSUBSTR = linux-perfctr-$(CPU)
MEMSUBSTR= linux
LIBS    = static shared
TARGETS = serial multiplex_and_pthreads shared

# This is a terrible idea
# Lines like this are a hack and should never be included.
#
POST_BUILD = cp $(PERFCTR_LIB_PATH)/libperfctr.so .;ln -s libperfctr.so libperfctr.so.5
SPECIAL_REMOVE = rm -f libperfctr.so libperfctr.so.5


CFLAGS  += -I$(PERFCTR_INC_PATH) -I$(PERFCTR_KINC_PATH)

CFLAGS-2.6.x := -DPERFCTR26
CFLAGS-2.7.x := $(CFLAGS-2.6.x)

PERFCTR_OBJS-2.4.5 := libperfctr.o
PERFCTR_OBJS-2.4.x := $(PERFCTR_OBJS-2.4.5)
PERFCTR_OBJS-2.6.x := marshal.o global.o misc.o virtual.o x86.o
PERFCTR_OBJS-2.7.x := $(PERFCTR_OBJS-2.6.x)

CFLAGS	+= $(CFLAGS-$(VERSION))
PERFCTR_OBJS := $(PERFCTR_OBJS-$(VERSION))

MISCHDRS = perfctr-$(CPU).h
SHLIBDEPS = -L$(PERFCTR_LIB_PATH) -lperfctr
MISCSRCS = linux.c $(CPU)_events.c
MISCOBJS = $(PERFCTR_OBJS) $(MISCSRCS:.c=.o) 

include Makefile.inc

$(PERFCTR_LIB_PATH)/libperfctr.a:
ifeq (,${PERFCTR_PREFIX})
	$(MAKE) -C $(PERFCTR)
else
	@echo '$@ not installed!'; exit 1
endif

$(PERFCTR_OBJS): $(PERFCTR_LIB_PATH)/libperfctr.a
	ar xv $<

$(CPU)_events.o: $(CPU)_events.c
	$(CC) $(LIBCFLAGS) $(OPTFLAGS) -c $^ -o $@

linux.o: linux.c
	$(CC) $(LIBCFLAGS) $(OPTFLAGS) -c $^ -o $@

native_clean:
ifeq (,${PERFCTR_PREFIX})
	$(MAKE) -C $(PERFCTR) clean
endif

native_install:
ifeq (,${PERFCTR_PREFIX})
ifeq (${VERSION},2.4.x)
native_install:
	cp -p $(PERFCTR)/usr.lib/libperfctr.so $(PREFIX)/lib$(LIB_SUFFIX)
	cp -p $(PERFCTR)/usr.lib/event_codes.h $(PREFIX)/include
	cp -p $(PERFCTR)/usr.lib/libperfctr.h  $(PREFIX)/include
else
native_install:
	$(MAKE) -C $(PERFCTR) PREFIX=$(PREFIX) install
endif
endif

native_clobber:
ifeq (,${PFM_PREFIX})
	$(MAKE) -C $(PERFCTR) distclean
endif
